<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HYO | Review Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* SENSES Series Typography */
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500&family=Manrope:wght@300;400&family=Shippori+Mincho:wght@400;500&family=Tenor+Sans&family=Zen+Kaku+Gothic+New:wght@300;400;500&display=swap');

        :root {
            /* Common Transition */
            --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* Theme: Sumi (Dark) */
        .theme-dark {
            --bg: #0A0A0A;
            --panel: #111111;
            --text: #F0F0F0;
            --sub: #666666;
            --line: #333333;
            --accent: #FFFFFF;
            --chart-bg: #050505;
        }

        /* Theme: Kami (Light) */
        .theme-light {
            --bg: #F2F2F2;
            --panel: #FFFFFF;
            --text: #111111;
            --sub: #888888;
            --line: #DDDDDD;
            --accent: #000000;
            --chart-bg: #EAEAEA;
        }

        body {
            font-family: 'Zen Kaku Gothic New', 'Manrope', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden; 
            height: 100vh;
            width: 100vw;
            transition: background-color 0.8s var(--ease-smooth), color 0.8s var(--ease-smooth);
        }

        /* --- Typography --- */
        .font-kanji { font-family: 'Shippori Mincho', serif; }
        .font-display { font-family: 'Tenor Sans', sans-serif; }
        .font-num { font-family: 'Jost', sans-serif; font-variant-numeric: tabular-nums; letter-spacing: 0.05em; }

        /* --- Intro Overlay --- */
        #intro {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: var(--bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 1.5s var(--ease-smooth), visibility 1.5s;
            cursor: pointer;
        }
        #intro.hidden-intro {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }

        .morph-container {
            position: relative;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .char-kanji {
            font-size: 5rem;
            color: var(--text);
            position: absolute;
            opacity: 1;
            filter: blur(0px);
            transition: all 1.4s cubic-bezier(0.55, 0, 0.1, 1);
        }
        .char-eng {
            font-family: 'Tenor Sans', sans-serif;
            font-size: 3rem;
            letter-spacing: 0.4em;
            color: var(--text);
            position: absolute;
            opacity: 0;
            filter: blur(12px);
            transform: scale(0.9);
            transition: all 1.4s cubic-bezier(0.55, 0, 0.1, 1);
        }
        .morphed .char-kanji { opacity: 0; filter: blur(24px); transform: scale(1.1); }
        .morphed .char-eng { opacity: 1; filter: blur(0px); transform: scale(1); }

        .click-guide {
            margin-top: 40px;
            font-family: 'Tenor Sans', sans-serif;
            font-size: 10px;
            letter-spacing: 0.25em;
            text-transform: uppercase;
            color: var(--sub);
            opacity: 0;
            animation: fadeInGuide 1.5s ease 1.5s forwards;
            transition: color 0.4s;
        }
        .click-guide:hover { color: var(--text); }
        @keyframes fadeInGuide { to { opacity: 1; } }

        /* --- Main UI Layout (Split View) --- */
        #ui-layer {
            position: relative;
            z-index: 10;
            height: 100%;
            width: 100%;
            display: flex; 
            opacity: 0;
            transition: opacity 2s ease 0.5s;
        }
        #ui-layer.visible { opacity: 1; }

        /* Left: Canvas Area */
        .preview-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: var(--chart-bg);
            padding: 2rem;
            position: relative;
            overflow: hidden;
            transition: background-color 0.8s var(--ease-smooth);
        }

        #chartCanvas {
            max-width: 100%;
            max-height: 100%;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            aspect-ratio: 16 / 9; 
            background: var(--bg);
            transition: box-shadow 0.8s var(--ease-smooth);
        }

        /* Right: Controls Area */
        .controls-area {
            width: 400px;
            background-color: var(--panel);
            border-left: 1px solid var(--line);
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            transition: background-color 0.8s var(--ease-smooth), border-color 0.8s var(--ease-smooth);
        }

        .controls-header {
            padding: 2rem;
            border-bottom: 1px solid var(--line);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: border-color 0.8s var(--ease-smooth);
        }
        .controls-body {
            padding: 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2.5rem;
        }
        .controls-footer {
            padding: 2rem;
            border-top: 1px solid var(--line);
            background-color: var(--panel);
            position: sticky;
            bottom: 0;
            transition: background-color 0.8s var(--ease-smooth), border-color 0.8s var(--ease-smooth);
        }

        .section-title {
            font-size: 10px;
            letter-spacing: 0.2em;
            color: var(--sub);
            border-bottom: 1px solid var(--line);
            padding-bottom: 5px;
            margin-bottom: 1rem;
            display: block;
        }

        /* Brand & Title */
        .brand {
            font-size: 11px;
            letter-spacing: 0.25em;
            color: var(--sub);
            margin-bottom: 1rem;
            display: block;
        }

        .model-input {
            background: transparent;
            border: none;
            color: var(--text);
            font-family: 'Tenor Sans', 'Zen Kaku Gothic New', sans-serif;
            font-size: 1.5rem;
            width: 100%;
            outline: none;
            letter-spacing: 0.05em;
            border-bottom: 1px solid var(--line);
            padding-bottom: 0.5rem;
            transition: border-color 0.3s, color 0.8s var(--ease-smooth);
        }
        .model-input:focus { border-bottom-color: var(--text); }
        .model-input::placeholder { color: var(--sub); opacity: 0.5; }

        /* Slider Items */
        .slider-item {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 1.5rem;
        }
        .slider-item:last-child { margin-bottom: 0; }
        
        .slider-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        .slider-label {
            font-size: 11px;
            letter-spacing: 0.1em;
            color: var(--sub);
            transition: color 0.8s var(--ease-smooth);
        }
        .slider-val {
            font-size: 14px;
            color: var(--text);
            font-weight: 400;
            transition: color 0.8s var(--ease-smooth);
        }
        .slider-meta {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--sub);
            margin-top: 4px;
            letter-spacing: 0.05em;
        }

        /* Horizontal Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
            cursor: pointer;
            height: 20px;
            display: block;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; 
            height: 1px; 
            background: var(--line);
            transition: background 0.8s var(--ease-smooth);
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px; 
            width: 12px; 
            background: var(--bg);
            border: 1px solid var(--text);
            border-radius: 50%;
            margin-top: -6px;
            transition: transform 0.2s, background-color 0.8s var(--ease-smooth), border-color 0.8s var(--ease-smooth);
        }
        input[type=range]:hover::-webkit-slider-thumb {
            transform: scale(1.2);
            background: var(--text);
        }
        input[type=range]:focus { outline: none; }

        /* Step Slider Style (for 1-5) */
        input[type=range].step-slider::-webkit-slider-runnable-track {
            height: 2px;
            background: var(--line);
        }

        /* Buttons */
        .btn-capture {
            width: 100%;
            font-family: 'Tenor Sans', sans-serif;
            font-size: 11px;
            letter-spacing: 0.3em;
            text-transform: uppercase;
            color: var(--text);
            border: 1px solid var(--sub);
            padding: 16px 0;
            background: transparent;
            cursor: pointer;
            transition: all 0.4s var(--ease-smooth);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-capture:hover {
            border-color: var(--text);
            background: var(--text);
            color: var(--bg);
        }

        #themeToggle {
            color: var(--sub);
            transition: color 0.3s;
        }
        #themeToggle:hover { color: var(--text); }

        @media (max-width: 800px) {
            #ui-layer { flex-direction: column; overflow-y: auto; }
            .preview-area { min-height: 300px; padding: 1rem; }
            .controls-area { width: 100%; border-left: none; border-top: 1px solid var(--line); }
            body { overflow-y: auto; }
        }

    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        border: "var(--line)",
                        input: "var(--line)",
                        ring: "var(--text)",
                        background: "var(--bg)",
                        foreground: "var(--text)",
                    }
                }
            }
        }
    </script>
</head>
<body class="theme-dark">

    <!-- Intro -->
    <div id="intro">
        <div class="morph-container">
            <span class="char-kanji font-kanji">評</span>
            <span class="char-eng font-display">HYO</span>
        </div>
        <div class="click-guide font-display">Initialize Generator</div>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        
        <!-- Left: Preview -->
        <div class="preview-area">
            <canvas id="chartCanvas"></canvas>
        </div>

        <!-- Right: Controls -->
        <div class="controls-area">
            
            <div class="controls-header">
                <div>
                    <span class="brand font-display">HYO / MODEL INFO</span>
                    <input type="text" id="modelName" class="model-input" placeholder="製品名を入力" value="UNTITLED" maxlength="25">
                </div>
                <button id="themeToggle" class="p-2">
                    <i data-lucide="sun" class="w-4 h-4 hidden theme-light-icon stroke-1"></i>
                    <i data-lucide="moon" class="w-4 h-4 hidden theme-dark-icon stroke-1"></i>
                </button>
            </div>

            <div class="controls-body">
                
                <!-- Section 1: Performance (0-10) -->
                <div>
                    <span class="section-title">PERFORMANCE (0-10.0)</span>
                    
                    <!-- 1. Bass -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">低域 / Bass</span>
                            <span class="slider-val font-num" id="valBass">5.0</span>
                        </div>
                        <input type="range" id="slBass" min="0" max="10" step="0.1" value="5">
                    </div>

                    <!-- 2. Mids -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">中域 / Mid</span>
                            <span class="slider-val font-num" id="valMids">5.0</span>
                        </div>
                        <input type="range" id="slMids" min="0" max="10" step="0.1" value="5">
                    </div>

                    <!-- 3. High -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">高域 / High</span>
                            <span class="slider-val font-num" id="valTreble">5.0</span>
                        </div>
                        <input type="range" id="slTreble" min="0" max="10" step="0.1" value="5">
                    </div>

                    <!-- 4. Stage -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">音場 / Stage</span>
                            <span class="slider-val font-num" id="valStage">5.0</span>
                        </div>
                        <input type="range" id="slStage" min="0" max="10" step="0.1" value="5">
                    </div>

                    <!-- 5. Detail -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">解像 / Detail</span>
                            <span class="slider-val font-num" id="valDetail">5.0</span>
                        </div>
                        <input type="range" id="slDetail" min="0" max="10" step="0.1" value="5">
                    </div>
                </div>

                <!-- Section 2: Character (1-5) -->
                <div>
                    <span class="section-title">CHARACTER (1-5)</span>

                    <!-- Tone (Cool/Warm) -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">音色 / Tone</span>
                        </div>
                        <input type="range" id="slTone" class="step-slider" min="1" max="5" step="1" value="3">
                        <div class="slider-meta">
                            <span>Cool</span>
                            <span>Warm</span>
                        </div>
                    </div>

                    <!-- Texture (Dry/Wet) -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">質感 / Texture</span>
                        </div>
                        <input type="range" id="slTexture" class="step-slider" min="1" max="5" step="1" value="3">
                        <div class="slider-meta">
                            <span>Dry</span>
                            <span>Wet</span>
                        </div>
                    </div>

                    <!-- Balance (Inst/Vocal) -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">帯域 / Balance</span>
                        </div>
                        <input type="range" id="slBalance" class="step-slider" min="1" max="5" step="1" value="3">
                        <div class="slider-meta">
                            <span>Instrument</span>
                            <span>Vocal</span>
                        </div>
                    </div>

                    <!-- Speed (Fast/Slow) -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">応答 / Speed</span>
                        </div>
                        <input type="range" id="slSpeed" class="step-slider" min="1" max="5" step="1" value="3">
                        <div class="slider-meta">
                            <span>Fast/Tight</span>
                            <span>Slow/Loose</span>
                        </div>
                    </div>

                    <!-- Usage (Monitor/Listening) -->
                    <div class="slider-item">
                        <div class="slider-header">
                            <span class="slider-label">用途 / Type</span>
                        </div>
                        <input type="range" id="slType" class="step-slider" min="1" max="5" step="1" value="3">
                        <div class="slider-meta">
                            <span>Monitor</span>
                            <span>Listening</span>
                        </div>
                    </div>

                </div>

            </div>

            <div class="controls-footer">
                <button id="btnCapture" class="btn-capture">
                    <i data-lucide="arrow-down-to-line" class="w-4 h-4"></i>
                    画像書き出し
                </button>
            </div>

        </div>

    </div>

    <script>
        /**
         * HYO - Review Chart Generator v3.2
         * Fixed variable scoping bug and optimized loop
         */

        const RADAR_LABELS = ["LOW", "MID", "HIGH", "STAGE", "RES"];
        const RADAR_JP = ["低域", "中域", "高域", "音場", "解像"];

        // State for Radar (0-10)
        // Fixed: Use one source of truth array, update it directly
        const radarValues = [5, 5, 5, 5, 5];
        const targetRadarValues = [5, 5, 5, 5, 5];

        // State for Character (1-5)
        const charValues = [3, 3, 3, 3, 3];
        const targetCharValues = [3, 3, 3, 3, 3];

        const state = {
            theme: localStorage.getItem('hyo_theme') || 'dark'
        };

        const dom = {
            body: document.body,
            intro: document.getElementById('intro'),
            morphContainer: document.querySelector('.morph-container'),
            ui: document.getElementById('ui-layer'),
            canvas: document.getElementById('chartCanvas'),
            modelName: document.getElementById('modelName'),
            btnCapture: document.getElementById('btnCapture'),
            themeToggle: document.getElementById('themeToggle'),
            // Radar Inputs
            radarInputs: [
                { sl: document.getElementById('slBass'), val: document.getElementById('valBass') },
                { sl: document.getElementById('slMids'), val: document.getElementById('valMids') },
                { sl: document.getElementById('slTreble'), val: document.getElementById('valTreble') },
                { sl: document.getElementById('slStage'), val: document.getElementById('valStage') },
                { sl: document.getElementById('slDetail'), val: document.getElementById('valDetail') }
            ],
            // Char Inputs
            charInputs: [
                document.getElementById('slTone'),
                document.getElementById('slTexture'),
                document.getElementById('slBalance'),
                document.getElementById('slSpeed'),
                document.getElementById('slType')
            ]
        };

        let ctx;
        let width, height;
        let frame = 0;

        // --- Core Functions ---

        const init = () => {
            ctx = dom.canvas.getContext('2d');
            resize();
            loop();
        };

        const resize = () => {
            // High resolution 16:9
            const w = 1200; 
            const h = 675; 
            dom.canvas.width = w;
            dom.canvas.height = h;
            width = w;
            height = h;
        };

        const getThemeColors = () => {
            const style = getComputedStyle(document.body);
            return {
                bg: style.getPropertyValue('--bg').trim(),
                text: style.getPropertyValue('--text').trim(),
                sub: style.getPropertyValue('--sub').trim(),
                line: style.getPropertyValue('--line').trim(),
                accent: style.getPropertyValue('--accent').trim()
            };
        };

        const loop = () => {
            const colors = getThemeColors();

            // Background
            ctx.fillStyle = colors.bg;
            ctx.fillRect(0, 0, width, height);

            // Interpolation
            let isMoving = false;
            // Radar Interpolation
            for(let i=0; i<5; i++) {
                const diff = targetRadarValues[i] - radarValues[i];
                if(Math.abs(diff) > 0.01) {
                    radarValues[i] += diff * 0.15;
                    isMoving = true;
                } else {
                    radarValues[i] = targetRadarValues[i];
                }
            }
            // Char Interpolation
            for(let i=0; i<5; i++) {
                const diff = targetCharValues[i] - charValues[i];
                if(Math.abs(diff) > 0.01) {
                    charValues[i] += diff * 0.15;
                    isMoving = true;
                } else {
                    charValues[i] = targetCharValues[i];
                }
            }
            if(isMoving) frame++;

            // --- Layout ---
            
            // Left: Radar Chart
            const cx = width * 0.3;
            const cy = height * 0.55;
            const radius = height * 0.35; 

            // 1. Grid
            ctx.strokeStyle = colors.line;
            ctx.lineWidth = 1;
            
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const x = cx + Math.cos(angle) * radius;
                const y = cy + Math.sin(angle) * radius;
                ctx.beginPath();
                ctx.moveTo(cx, cy);
                ctx.lineTo(x, y);
                ctx.stroke();
            }
            
            for(let r=0.2; r<=1.0; r+=0.2) {
                 drawPolygon(cx, cy, radius * r, false, colors.line);
            }

            // 2. Labels
            ctx.fillStyle = colors.sub;
            ctx.font = '300 16px "Jost", sans-serif';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            const labelDist = radius + 35;

            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const x = cx + Math.cos(angle) * labelDist;
                const y = cy + Math.sin(angle) * labelDist;
                ctx.fillText(RADAR_LABELS[i], x, y - 8);
                
                // Japanese sub-label
                ctx.font = '400 11px "Zen Kaku Gothic New", sans-serif';
                ctx.fillStyle = colors.line;
                ctx.fillText(RADAR_JP[i], x, y + 10);
                
                // Reset font
                ctx.fillStyle = colors.sub;
                ctx.font = '300 16px "Jost", sans-serif';
            }

            // 3. Data Shape
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const r = (radarValues[i] / 10) * radius;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fillStyle = hexToRgba(colors.text, 0.05); 
            ctx.fill();
            ctx.strokeStyle = colors.text;
            ctx.lineWidth = 2.5;
            ctx.stroke();

            // 4. Points
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const r = (radarValues[i] / 10) * radius;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI*2);
                ctx.fillStyle = colors.bg;
                ctx.fill();
                ctx.stroke();
            }

            // --- Right: Info Panel ---
            const panelX = width * 0.62;
            const panelY = 100;
            ctx.textAlign = 'left';

            // Vertical Line
            ctx.strokeStyle = colors.line;
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(width * 0.55, 80);
            ctx.lineTo(width * 0.55, height - 80);
            ctx.stroke();

            // Model Name
            ctx.fillStyle = colors.text;
            ctx.font = '400 48px "Tenor Sans", sans-serif';
            ctx.fillText(dom.modelName.value, panelX, panelY);

            // Sub Title
            ctx.fillStyle = colors.sub;
            ctx.font = '300 14px "Jost", sans-serif';
            ctx.fillText("HYO / AUDIO METRICS", panelX, panelY + 30);

            // --- Character Bars (5 Items) ---
            const charStartY = panelY + 100;
            const charGap = 75; // Reduced gap to fit 5 items
            const barWidth = 320;
            
            const charLabels = [
                { l: "Cool", r: "Warm" },
                { l: "Dry", r: "Wet" },
                { l: "Instrument", r: "Vocal" },
                { l: "Fast", r: "Slow" },
                { l: "Monitor", r: "Listening" }
            ];

            for(let i=0; i<5; i++) {
                const y = charStartY + (i * charGap);
                
                // Labels L/R
                ctx.fillStyle = colors.sub;
                ctx.font = '300 12px "Jost", sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(charLabels[i].l.toUpperCase(), panelX, y - 12);
                ctx.textAlign = 'right';
                ctx.fillText(charLabels[i].r.toUpperCase(), panelX + barWidth, y - 12);

                // Bar Track (Dots)
                const dotCount = 5;
                const stepW = barWidth / (dotCount - 1);
                
                for(let d=0; d<dotCount; d++) {
                    const dx = panelX + (d * stepW);
                    ctx.beginPath();
                    ctx.arc(dx, y, 2, 0, Math.PI*2);
                    ctx.fillStyle = colors.line;
                    ctx.fill();
                }

                // Active Indicator (Circle)
                const valNorm = charValues[i] - 1; // 0-4
                const activeX = panelX + (valNorm * stepW);

                // Circle
                ctx.beginPath();
                ctx.arc(activeX, y, 6, 0, Math.PI*2);
                ctx.fillStyle = colors.text;
                ctx.fill();
                
                // Glow
                ctx.shadowBlur = 10;
                ctx.shadowColor = colors.text;
                ctx.fill();
                ctx.shadowBlur = 0;
            }

            // Radar Values List (Small)
            // Draw numerical values next to radar points for clarity
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const r = (radarValues[i] / 10) * radius;
                const x = cx + Math.cos(angle) * r;
                const y = cy + Math.sin(angle) * r;
                
                // Offset text
                const textDist = 20;
                const tx = x + Math.cos(angle) * textDist;
                const ty = y + Math.sin(angle) * textDist;
                
                ctx.fillStyle = colors.text;
                ctx.font = '300 14px "Jost", sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                if(radarValues[i] > 1) {
                    ctx.fillText(radarValues[i].toFixed(1), tx, ty);
                }
            }


            // Signature
            ctx.textAlign = 'right';
            ctx.fillStyle = colors.line;
            ctx.font = '11px "Manrope", sans-serif';
            ctx.fillText("Generated by SENSES/HYO", width - 60, height - 40);

            requestAnimationFrame(loop);
        };

        const drawPolygon = (x, y, r, fill, color) => {
            ctx.beginPath();
            for (let i = 0; i < 5; i++) {
                const angle = (Math.PI * 2 * i) / 5 - Math.PI / 2;
                const px = x + Math.cos(angle) * r;
                const py = y + Math.sin(angle) * r;
                if (i === 0) ctx.moveTo(px, py);
                else ctx.lineTo(px, py);
            }
            ctx.closePath();
            ctx.strokeStyle = color;
            ctx.stroke();
        };

        const hexToRgba = (hex, alpha) => {
            let r = 0, g = 0, b = 0;
            if (hex.length === 4) {
                r = parseInt(hex[1] + hex[1], 16);
                g = parseInt(hex[2] + hex[2], 16);
                b = parseInt(hex[3] + hex[3], 16);
            } else if (hex.length === 7) {
                r = parseInt(hex.substring(1, 3), 16);
                g = parseInt(hex.substring(3, 5), 16);
                b = parseInt(hex.substring(5, 7), 16);
            }
            return `rgba(${r}, ${g}, ${b}, ${alpha})`;
        };

        const exportImage = () => {
            dom.canvas.style.opacity = 0.5;
            setTimeout(() => dom.canvas.style.opacity = 1, 100);

            const link = document.createElement('a');
            const model = dom.modelName.value || 'Review';
            link.download = `HYO_${model.replace(/[^a-z0-9]/gi, '_').toLowerCase()}.png`;
            link.href = dom.canvas.toDataURL('image/png');
            link.click();
        };

        const setTheme = (theme) => {
            state.theme = theme;
            localStorage.setItem('hyo_theme', theme);
            
            const isDark = theme === 'dark';
            dom.body.classList.toggle('theme-dark', isDark);
            dom.body.classList.toggle('theme-light', !isDark);
            
            dom.themeToggle.querySelector('.theme-light-icon').classList.toggle('hidden', !isDark);
            dom.themeToggle.querySelector('.theme-dark-icon').classList.toggle('hidden', isDark);
        };

        // --- Event Listeners ---

        // Radar Inputs
        dom.radarInputs.forEach((item, index) => {
            item.sl.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                targetRadarValues[index] = val;
                item.val.innerText = val.toFixed(1);
            });
        });

        // Char Inputs
        dom.charInputs.forEach((input, index) => {
            input.addEventListener('input', (e) => {
                const val = parseFloat(e.target.value);
                targetCharValues[index] = val;
            });
        });

        dom.intro.addEventListener('click', () => {
            dom.morphContainer.classList.add('morphed');
            setTimeout(() => {
                dom.intro.classList.add('hidden-intro');
                dom.ui.classList.add('visible');
                init();
            }, 1400);
        });

        dom.btnCapture.addEventListener('click', exportImage);
        
        dom.themeToggle.addEventListener('click', () => {
            const current = dom.body.classList.contains('theme-dark') ? 'dark' : 'light';
            setTheme(current === 'dark' ? 'light' : 'dark');
        });

        // Init
        window.addEventListener('load', () => {
            const saved = localStorage.getItem('hyo_theme') || 'dark';
            setTheme(saved);
            
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
                dom.themeToggle.querySelector('.theme-light-icon').classList.add('lucide', 'lucide-sun');
                dom.themeToggle.querySelector('.theme-dark-icon').classList.add('lucide', 'lucide-moon');
            }
        });

    </script>
</body>
</html>