<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENSES : ZEN | Code Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500&family=Manrope:wght@200;300;400&family=Shippori+Mincho:wght@400;500&family=Tenor+Sans&display=swap');

        :root {
            --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-heavy: all 1000ms var(--ease-smooth);
            --transition-fast: all 400ms var(--ease-smooth);
        }

        /* Theme: Obsidian (Dark) */
        html.theme-dark {
            --bg: #050505;
            --panel: #0A0A0A;
            --text: #FFFFFF;
            --sub: #555555;
            --line: #222222;
            --line-strong: #333333;
            --accent: #FFFFFF;
            --invert-text: #000000;
            --helper-grid: rgba(255, 255, 255, 0.03);
        }

        /* Theme: Paper (Light) */
        html.theme-light {
            --bg: #F5F7FA;
            --panel: #FFFFFF;
            --text: #050505;
            --sub: #9999AA;
            --line: #E5E5E5;
            --line-strong: #CCCCCC;
            --accent: #000000;
            --invert-text: #FFFFFF;
            --helper-grid: rgba(0, 0, 0, 0.03);
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Manrope', sans-serif;
            transition: var(--transition-heavy);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
            -webkit-user-select: none;
        }

        .font-kanji { font-family: 'Shippori Mincho', serif; }
        .font-display { font-family: 'Tenor Sans', sans-serif; letter-spacing: 0.25em; text-transform: uppercase; }
        
        /* --- SENSES Intro --- */
        #intro {
            position: fixed; inset: 0; z-index: 100;
            background-color: var(--bg);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1.5s var(--ease-smooth), visibility 1.5s;
            cursor: pointer;
        }
        #intro.hidden-intro { opacity: 0; visibility: hidden; pointer-events: none; }
        .morph-container { position: relative; height: 120px; display: flex; align-items: center; justify-content: center; }
        .char-kanji { font-size: 5rem; color: var(--text); position: absolute; opacity: 1; filter: blur(0px); transition: all 1.4s cubic-bezier(0.55, 0, 0.1, 1); }
        .char-eng { font-family: 'Tenor Sans', sans-serif; font-size: 3rem; letter-spacing: 0.4em; color: var(--text); position: absolute; opacity: 0; filter: blur(12px); transform: scale(0.9); transition: all 1.4s cubic-bezier(0.55, 0, 0.1, 1); }
        .morphed .char-kanji { opacity: 0; filter: blur(24px); transform: scale(1.1); }
        .morphed .char-eng { opacity: 1; filter: blur(0px); transform: scale(1); }

        /* --- Layout --- */
        #ui-layer {
            display: none; height: 100vh; width: 100vw; grid-template-rows: 1fr auto;
        }
        #ui-layer.ready { display: grid; }
        @media (min-width: 768px) { #ui-layer { grid-template-rows: none; grid-template-columns: 1fr 420px; } }

        /* Garden Display */
        .stage-area {
            position: relative; background-color: var(--bg);
            display: flex; align-items: center; justify-content: center;
            border-bottom: 1px solid var(--line);
        }
        @media (min-width: 768px) { .stage-area { border-bottom: none; border-right: 1px solid var(--line); } }

        .garden-frame {
            position: relative; width: 90vw; height: 90vw; max-width: 600px; max-height: 600px;
            border: 1px solid var(--line-strong); background-color: var(--bg);
            background-image: linear-gradient(var(--helper-grid) 1px, transparent 1px), linear-gradient(90deg, var(--helper-grid) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .axis-label { position: absolute; font-family: 'Tenor Sans'; font-size: 8px; color: var(--sub); letter-spacing: 0.2em; pointer-events: none; }

        /* Sidebar Controls */
        .sidebar {
            background-color: var(--panel); padding: 1.5rem; display: flex; flex-direction: column; gap: 1.5rem; overflow-y: auto;
        }
        @media (min-width: 768px) { .sidebar { padding: 2.5rem; } }

        /* Code Input */
        .code-area {
            width: 100%; height: 120px; background: var(--bg); border: 1px solid var(--line);
            color: var(--text); font-family: monospace; font-size: 11px; padding: 10px;
            outline: none; resize: none; transition: border-color 0.3s;
        }
        .code-area:focus { border-color: var(--text); }

        .stone {
            position: absolute; padding: 6px 14px; border: 1px solid var(--text); background-color: var(--bg);
            cursor: move; display: flex; align-items: center; gap: 8px; font-size: 0.7rem;
            transform: translate(-50%, -50%); z-index: 10; transition: border-style 0.2s;
            touch-action: none;
        }
        .stone.dragging { background-color: var(--text); color: var(--invert-text); border-style: dashed; z-index: 100; scale: 1.1; }
        .stone .label { font-family: 'Tenor Sans'; font-size: 0.6rem; opacity: 0.7; }

        .btn-action {
            width: 100%; padding: 1rem; border: 1px solid var(--text);
            background: transparent; color: var(--text); font-family: 'Tenor Sans';
            font-size: 0.7rem; letter-spacing: 0.25em; transition: var(--transition-fast);
            cursor: pointer; text-transform: uppercase;
        }
        .btn-action:hover { background-color: var(--text); color: var(--invert-text); }
        
        #export-canvas { display: none; }
        .message-box { font-size: 10px; color: #ff5555; height: 14px; }
    </style>
</head>
<body class="theme-dark">

    <!-- Intro -->
    <div id="intro">
        <div class="morph-container">
            <span class="char-kanji font-kanji">庭</span>
            <span class="char-eng font-display">TEI</span>
        </div>
        <div class="mt-8 font-display text-[9px] opacity-0 animate-pulse tracking-widest">CODE SYNC ENGINE READY</div>
    </div>

    <div id="ui-layer">
        <!-- Stage -->
        <div class="stage-area">
            <div class="garden-frame" id="garden">
                <div class="w-full h-px bg-[var(--line-strong)] absolute top-1/2"></div>
                <div class="h-full w-px bg-[var(--line-strong)] absolute left-1/2"></div>
                
                <div class="axis-label top-2 left-1/2 -translate-x-1/2">DEPTH (+)</div>
                <div class="axis-label bottom-2 left-1/2 -translate-x-1/2">DEPTH (-)</div>
                <div class="axis-label left-2 top-1/2 -translate-y-1/2 -rotate-90">WIDTH (L)</div>
                <div class="axis-label right-2 top-1/2 -translate-y-1/2 rotate-90">WIDTH (R)</div>
                
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-2 border border-[var(--text)] bg-[var(--bg)] z-0"></div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="flex justify-between items-center mb-2">
                <h1 class="font-display text-xs">TEI / CODE SYNC</h1>
                <button id="themeToggle" class="p-1 opacity-40 hover:opacity-100 transition-opacity">
                    <i data-lucide="moon" class="w-4 h-4"></i>
                </button>
            </div>

            <!-- Sync Block -->
            <div class="space-y-3">
                <label class="text-[9px] text-[var(--sub)] uppercase tracking-widest">Paste Analysis Code</label>
                <textarea id="codeSyncInput" class="code-area" placeholder='{ "modelName": "...", "stones": [...] }'></textarea>
                <div id="syncMessage" class="message-box"></div>
                <button id="btnSync" class="btn-action">Sync Garden / 同期</button>
            </div>

            <!-- Manual Edits -->
            <div class="space-y-4 pt-4 border-t border-[var(--line)]">
                <div class="input-group">
                    <label class="text-[9px] text-[var(--sub)] uppercase tracking-widest mb-2 block">Current Project</label>
                    <input type="text" id="reviewName" class="w-full bg-transparent border-b border-[var(--line)] py-2 outline-none font-display text-lg" value="UNTITLED SETUP">
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button class="btn-add btn-action text-[9px]" data-label="BASS" data-kanji="低">低 / BASS</button>
                    <button class="btn-add btn-action text-[9px]" data-label="VOCAL" data-kanji="歌">歌 / VOCAL</button>
                </div>
            </div>

            <div class="mt-auto space-y-3">
                <button id="btnExport" class="btn-action flex items-center justify-center gap-2">
                    <i data-lucide="camera" class="w-3 h-3"></i> Capture for Note
                </button>
                <button id="btnReset" class="btn-action opacity-30 border-dashed text-[10px]">Reset Garden</button>
            </div>
        </div>
    </div>

    <canvas id="export-canvas"></canvas>

    <script>
        const SNAP_UNIT = 20;
        const state = {
            theme: localStorage.getItem('tei_theme') || 'dark',
            isDragging: false,
            activeStone: null
        };

        const dom = {
            intro: document.getElementById('intro'),
            ui: document.getElementById('ui-layer'),
            garden: document.getElementById('garden'),
            codeIn: document.getElementById('codeSyncInput'),
            btnSync: document.getElementById('btnSync'),
            msg: document.getElementById('syncMessage'),
            reviewName: document.getElementById('reviewName')
        };

        window.addEventListener('load', () => {
            setTheme(state.theme);
            lucide.createIcons();
            dom.intro.addEventListener('click', () => {
                dom.intro.classList.add('morphed');
                setTimeout(() => { dom.intro.classList.add('hidden-intro'); dom.ui.classList.add('ready'); }, 1400);
            });
            setupListeners();
        });

        function setupListeners() {
            dom.btnSync.addEventListener('click', syncCode);
            document.getElementById('btnExport').addEventListener('click', exportMap);
            document.getElementById('btnReset').addEventListener('click', () => dom.garden.querySelectorAll('.stone').forEach(s => s.remove()));
            document.querySelectorAll('.btn-add').forEach(btn => btn.addEventListener('click', () => createStone(btn.dataset.label, btn.dataset.kanji, 0, 0)));
            document.getElementById('themeToggle').addEventListener('click', () => setTheme(state.theme === 'dark' ? 'light' : 'dark'));

            window.addEventListener('mousemove', handleDrag);
            window.addEventListener('touchmove', handleDrag, { passive: false });
            window.addEventListener('mouseup', endDrag);
            window.addEventListener('touchend', endDrag);
        }

        function syncCode() {
            try {
                const data = JSON.parse(dom.codeIn.value);
                if(!data.stones) throw new Error("Format invalid");
                
                dom.garden.querySelectorAll('.stone').forEach(s => s.remove());
                dom.reviewName.value = data.modelName || "UNTITLED";
                
                data.stones.forEach(s => {
                    // Convert -100/100 to 0/600px
                    const x = 300 + (s.x / 100 * 300);
                    const y = 300 - (s.y / 100 * 300); // Inverse Y for Depth+ up
                    createStone(s.label, s.kanji, x, y);
                });
                dom.msg.innerText = "Synced successfully.";
                dom.msg.style.color = "#55ff55";
            } catch(e) {
                dom.msg.innerText = "Error: Invalid JSON format.";
                dom.msg.style.color = "#ff5555";
            }
        }

        function createStone(label, kanji, x, y) {
            const stone = document.createElement('div');
            stone.className = 'stone font-kanji';
            stone.innerHTML = `<span class="kanji">${kanji}</span><span class="label">${label}</span>`;
            
            // Initial positioning
            stone.style.left = `${Math.round(x/SNAP_UNIT)*SNAP_UNIT}px`;
            stone.style.top = `${Math.round(y/SNAP_UNIT)*SNAP_UNIT}px`;
            dom.garden.appendChild(stone);

            const start = (e) => {
                e.preventDefault(); state.isDragging = true; state.activeStone = stone; stone.classList.add('dragging');
            };
            stone.addEventListener('mousedown', start);
            stone.addEventListener('touchstart', start);
            stone.addEventListener('dblclick', () => stone.remove());
        }

        function handleDrag(e) {
            if (!state.isDragging || !state.activeStone) return;
            const rect = dom.garden.getBoundingClientRect();
            const touch = e.touches ? e.touches[0] : e;
            // Map screen coords to 600px grid
            let x = Math.round(((touch.clientX - rect.left) / rect.width * 600) / SNAP_UNIT) * SNAP_UNIT;
            let y = Math.round(((touch.clientY - rect.top) / rect.height * 600) / SNAP_UNIT) * SNAP_UNIT;
            state.activeStone.style.left = `${Math.max(0, Math.min(x, 600))}px`;
            state.activeStone.style.top = `${Math.max(0, Math.min(y, 600))}px`;
        }

        function endDrag() { if(state.activeStone) state.activeStone.classList.remove('dragging'); state.isDragging = false; state.activeStone = null; }

        function setTheme(theme) {
            state.theme = theme; localStorage.setItem('tei_theme', theme);
            document.documentElement.className = `theme-${theme}`;
        }

        function exportMap() {
            const canvas = document.getElementById('export-canvas');
            const size = 1200; canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');
            const style = getComputedStyle(document.documentElement);
            const bgColor = style.getPropertyValue('--bg').trim();
            const textColor = style.getPropertyValue('--text').trim();
            const subColor = style.getPropertyValue('--sub').trim();

            ctx.fillStyle = bgColor; ctx.fillRect(0, 0, size, size);
            
            // Clean Note Export: Border and simple grid
            ctx.strokeStyle = subColor; ctx.lineWidth = 1; ctx.strokeRect(40, 40, size-80, size-80);
            
            ctx.strokeStyle = style.getPropertyValue('--line-strong').trim();
            ctx.beginPath(); ctx.moveTo(size/2, 100); ctx.lineTo(size/2, size-100); ctx.moveTo(100, size/2); ctx.lineTo(size-100, size/2); ctx.stroke();

            // Axis Info
            ctx.fillStyle = subColor; ctx.font = '22px "Tenor Sans"'; ctx.textAlign = 'center';
            ctx.fillText("DEPTH (+)", size/2, 80); ctx.fillText("DEPTH (-)", size/2, size-65);
            ctx.save(); ctx.translate(65, size/2); ctx.rotate(-Math.PI/2); ctx.fillText("WIDTH (LEFT)", 0, 0); ctx.restore();
            ctx.save(); ctx.translate(size-65, size/2); ctx.rotate(Math.PI/2); ctx.fillText("WIDTH (RIGHT)", 0, 0); ctx.restore();

            dom.garden.querySelectorAll('.stone').forEach(s => {
                const x = (parseFloat(s.style.left) / 600) * size;
                const y = (parseFloat(s.style.top) / 600) * size;
                const label = s.querySelector('.label').textContent;
                const kanji = s.querySelector('.kanji').textContent;
                ctx.font = '20px "Tenor Sans"';
                const w = ctx.measureText(label).width + 120;
                ctx.fillStyle = bgColor; ctx.fillRect(x-w/2, y-35, w, 70);
                ctx.strokeStyle = textColor; ctx.lineWidth = 2.5; ctx.strokeRect(x-w/2, y-35, w, 70);
                ctx.fillStyle = textColor; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                ctx.font = '36px "Shippori Mincho"'; ctx.fillText(kanji, x-w/2+35, y);
                ctx.font = '22px "Tenor Sans"'; ctx.fillText(label, x+25, y);
            });

            const name = dom.reviewName.value.toUpperCase();
            ctx.textAlign = 'left'; ctx.font = '300 48px "Tenor Sans"'; ctx.fillStyle = textColor; ctx.fillText(name, 80, 130);
            ctx.textAlign = 'right'; ctx.font = '14px "Tenor Sans"'; ctx.fillStyle = subColor; ctx.fillText("SENSES : ZEN // GENERATED MAP", size-80, size-100);

            const link = document.createElement('a'); link.download = `TEI_Map_${name}.png`; link.href = canvas.toDataURL('image/png'); link.click();
        }
    </script>
</body>
</html>
