<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SENSES : IRO | Chromatic Harmony</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Jost:wght@200;300;400;500&family=Manrope:wght@200;300;400&family=Shippori+Mincho:wght@400;500&family=Tenor+Sans&display=swap');

        :root {
            --ease-smooth: cubic-bezier(0.16, 1, 0.3, 1);
            --transition-heavy: all 1200ms var(--ease-smooth);
        }

        body {
            background-color: #F6F6F6;
            color: #050505;
            font-family: 'Manrope', sans-serif;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            overflow-y: auto;
            user-select: none;
            -webkit-user-select: none;
        }

        .font-kanji { font-family: 'Shippori Mincho', serif; }
        .font-display { font-family: 'Tenor Sans', sans-serif; letter-spacing: 0.4em; text-transform: uppercase; }
        .font-num { font-family: 'Jost', sans-serif; letter-spacing: 0.1em; }

        /* --- SENSES Intro --- */
        #intro {
            position: fixed; inset: 0; z-index: 100; background-color: #FFFFFF;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1.5s var(--ease-smooth), visibility 1.5s; cursor: pointer;
        }
        #intro.hidden-intro { opacity: 0; visibility: hidden; pointer-events: none; }
        .morph-container { position: relative; height: 120px; display: flex; align-items: center; justify-content: center; }
        .char-kanji { font-size: 5rem; color: #050505; position: absolute; opacity: 1; filter: blur(0px); transition: all 1.5s var(--ease-smooth); }
        .char-eng { font-family: 'Tenor Sans', sans-serif; font-size: 3rem; letter-spacing: 0.5em; color: #050505; position: absolute; opacity: 0; filter: blur(16px); transform: scale(0.9); transition: all 1.5s var(--ease-smooth); }
        .morphed .char-kanji { opacity: 0; filter: blur(24px); transform: scale(1.1); }
        .morphed .char-eng { opacity: 1; filter: blur(0px); transform: scale(1); }

        /* --- Layout --- */
        #ui-layer { display: none; min-height: 100vh; width: 100vw; }
        #ui-layer.ready { display: block; }
        
        .app-grid { display: grid; grid-template-columns: 1fr; }
        @media (min-width: 1024px) {
            .app-grid { grid-template-columns: 1fr 400px; height: 100vh; overflow: hidden; }
        }

        /* Editor Area */
        .editor {
            position: relative; background-color: #E8E8E8;
            display: flex; align-items: center; justify-content: center;
            padding: 20px; min-height: 50vh;
        }
        @media (min-width: 1024px) { .editor { height: 100vh; padding: 60px; } }

        .image-container {
            position: relative; line-height: 0;
            box-shadow: 0 40px 100px -20px rgba(0,0,0,0.1);
            max-width: 100%; max-height: 100%;
            transition: var(--transition-heavy);
        }
        #target-image {
            max-width: 100%; max-height: 70vh; pointer-events: none;
            display: block; opacity: 0; transition: opacity 1s;
        }

        /* Picker Pins */
        .pin {
            position: absolute; width: 44px; height: 44px;
            transform: translate(-50%, -50%);
            cursor: move; z-index: 50;
            display: flex; align-items: center; justify-content: center;
            touch-action: none;
        }
        .pin-cross-h, .pin-cross-v { position: absolute; background: white; mix-blend-mode: difference; opacity: 0.8; }
        .pin-cross-h { width: 24px; height: 1px; }
        .pin-cross-v { height: 24px; width: 1px; }
        .pin-dot { width: 4px; height: 4px; background: white; border-radius: 50%; z-index: 2; box-shadow: 0 0 0 1px black; }

        /* Sidebar */
        .sidebar {
            background-color: #FFFFFF; padding: 2rem 1.5rem;
            display: flex; flex-direction: column; gap: 2rem;
            border-top: 1px solid #EEEEEE;
        }
        @media (min-width: 1024px) {
            .sidebar { padding: 3rem 2.5rem; border-top: none; border-left: 1px solid #EEEEEE; overflow-y: auto; }
        }

        .drop-zone {
            width: 100%; height: 80px; border: 1px solid #EEE;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s; gap: 0.5rem;
        }
        .drop-zone:hover { border-color: #050505; background-color: #FAFAFA; }
        .drop-zone p { font-size: 8px; tracking-[0.2em] color: #AAA; text-transform: uppercase; }

        /* Live Preview Frame */
        .artifact-preview {
            width: 100%; aspect-ratio: 1/1;
            background: #F9F9F9; border: 1px solid #EEE;
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
            transition: var(--transition-heavy);
        }
        #preview-canvas { width: 100%; height: 100%; object-fit: contain; }

        /* HEX Strips */
        .strip-container { display: flex; flex-direction: column; width: 100%; border: 1px solid #EEE; }
        .strip {
            height: 40px; display: flex; align-items: center; justify-content: space-between;
            padding: 0 16px; transition: background 0.3s var(--ease-smooth);
        }
        .strip-hex { font-size: 10px; font-family: 'Jost'; letter-spacing: 0.1em; mix-blend-mode: difference; color: white; }
        .strip-idx { font-size: 7px; opacity: 0.5; mix-blend-mode: difference; color: white; }

        .btn-action {
            width: 100%; padding: 1.25rem; border: 1px solid #050505;
            background: transparent; color: #050505; font-family: 'Tenor Sans';
            font-size: 0.75rem; letter-spacing: 0.3em; transition: all 0.4s var(--ease-smooth);
            cursor: pointer; text-transform: uppercase;
        }
        .btn-action:hover { background-color: #050505; color: #FFFFFF; }
        .btn-action:disabled { opacity: 0.1; cursor: not-allowed; border-color: #EEE; }

        .label-tech { font-size: 7px; tracking-[0.4em] color: #CCC; text-transform: uppercase; margin-bottom: 0.25rem; display: block; }
        
        #export-canvas { display: none; }
    </style>
</head>
<body>

    <!-- Intro -->
    <div id="intro">
        <div class="morph-container">
            <span class="char-kanji font-kanji">è‰²</span>
            <span class="char-eng font-display">IRO</span>
        </div>
        <div class="mt-8 font-display text-[9px] opacity-0 animate-pulse tracking-[0.5em]">CHROMATIC_HARMONY_v3</div>
    </div>

    <!-- UI -->
    <div id="ui-layer">
        <div class="app-grid">
            <!-- Viewer: The Sourcing Area -->
            <section class="editor">
                <div id="image-frame" class="image-container hidden">
                    <img id="target-image" draggable="false">
                    <div id="pin-layer" class="absolute inset-0"></div>
                </div>
                <div id="empty-state" class="absolute font-display text-[10px] text-[#CCC] tracking-[1.5em]">SOURCE_ARTIFACT_REQUIRED</div>
            </section>

            <!-- Sidebar: The Refinement Area -->
            <section class="sidebar">
                <div class="header">
                    <h1 class="font-display text-xs">IRO / GRADIENT BARS</h1>
                    <p class="text-[8px] text-[#BBB] mt-1 uppercase tracking-[0.4em]">Ordered Chromatic Sequence</p>
                </div>

                <!-- Input -->
                <div class="space-y-1">
                    <span class="label-tech">Source_input</span>
                    <div id="drop-zone" class="drop-zone">
                        <i data-lucide="camera" class="w-4 h-4 stroke-[1] text-[#CCC]"></i>
                        <p>Load Artifact</p>
                        <input type="file" id="file-input" class="hidden" accept="image/*">
                    </div>
                </div>

                <!-- Live Preview (Artifact Mini) -->
                <div class="space-y-1">
                    <span class="label-tech">Artifact_Preview</span>
                    <div class="artifact-preview" id="preview-box">
                        <canvas id="preview-canvas"></canvas>
                    </div>
                </div>

                <!-- Gradient Strips -->
                <div class="space-y-1">
                    <span class="label-tech">Sorted_Spectrum_Data</span>
                    <div class="strip-container" id="strip-list">
                        <!-- Strips Injected Here -->
                    </div>
                </div>

                <!-- Action -->
                <div class="mt-4 lg:mt-auto space-y-6">
                    <button id="btn-download" class="btn-action" disabled>
                        Finalize Palette
                    </button>
                    <div class="font-display text-[8px] text-[#EEE] tracking-[0.6em] text-center pb-8 lg:pb-0">SENSES_ARCHIVE_IRO</div>
                </div>
            </section>
        </div>
    </div>

    <!-- Hidden Canvases -->
    <canvas id="export-canvas"></canvas>
    <canvas id="buffer-canvas" style="display:none;"></canvas>

    <script>
        /**
         * IRO - Chromatic Harmony Generator v3
         * Logic: Automatic Gradient Sorting & Artifact Preview
         */

        const state = {
            image: null,
            filename: "iro_harmony",
            points: [
                {x: 0.2, y: 0.2, r:255, g:255, b:255, hex: '#FFFFFF', lum: 1},
                {x: 0.8, y: 0.2, r:255, g:255, b:255, hex: '#FFFFFF', lum: 1},
                {x: 0.5, y: 0.5, r:255, g:255, b:255, hex: '#FFFFFF', lum: 1},
                {x: 0.2, y: 0.8, r:255, g:255, b:255, hex: '#FFFFFF', lum: 1},
                {x: 0.8, y: 0.8, r:255, g:255, b:255, hex: '#FFFFFF', lum: 1}
            ],
            activePinIdx: null
        };

        const dom = {
            intro: document.getElementById('intro'),
            ui: document.getElementById('ui-layer'),
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            targetImage: document.getElementById('target-image'),
            imageFrame: document.getElementById('image-frame'),
            pinLayer: document.getElementById('pin-layer'),
            stripList: document.getElementById('strip-list'),
            previewCanvas: document.getElementById('preview-canvas'),
            emptyState: document.getElementById('empty-state'),
            btnDownload: document.getElementById('btn-download'),
            exportCanvas: document.getElementById('export-canvas'),
            bufferCanvas: document.getElementById('buffer-canvas')
        };

        window.addEventListener('load', () => {
            lucide.createIcons();
            dom.intro.addEventListener('click', () => {
                dom.intro.classList.add('morphed');
                setTimeout(() => {
                    dom.intro.classList.add('hidden-intro');
                    dom.ui.classList.add('ready');
                }, 1400);
            });
            setupListeners();
        });

        function setupListeners() {
            dom.dropZone.addEventListener('click', () => dom.fileInput.click());
            dom.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

            window.addEventListener('mousemove', onMouseMove);
            window.addEventListener('touchmove', onTouchMove, { passive: false });
            window.addEventListener('mouseup', onEndMove);
            window.addEventListener('touchend', onEndMove);

            dom.btnDownload.addEventListener('click', downloadPalette);
        }

        function handleFile(file) {
            if (!file || !file.type.startsWith('image/')) return;
            state.filename = file.name.split('.')[0];
            
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    state.image = img;
                    dom.targetImage.src = e.target.result;
                    dom.targetImage.style.opacity = 1;
                    dom.imageFrame.classList.remove('hidden');
                    dom.emptyState.classList.add('hidden');
                    dom.btnDownload.disabled = false;
                    
                    dom.bufferCanvas.width = img.naturalWidth;
                    dom.bufferCanvas.height = img.naturalHeight;
                    dom.bufferCanvas.getContext('2d').drawImage(img, 0, 0);
                    
                    initPins();
                    updatePalette();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function initPins() {
            dom.pinLayer.innerHTML = '';
            state.points.forEach((p, i) => {
                const pin = document.createElement('div');
                pin.className = 'pin';
                pin.style.left = `${p.x * 100}%`;
                pin.style.top = `${p.y * 100}%`;
                pin.innerHTML = `<div class="pin-cross-h"></div><div class="pin-cross-v"></div><div class="pin-dot"></div>`;
                
                const startMove = (e) => {
                    e.preventDefault();
                    state.activePinIdx = i;
                };
                pin.addEventListener('mousedown', startMove);
                pin.addEventListener('touchstart', startMove);
                dom.pinLayer.appendChild(pin);
            });
        }

        function onMouseMove(e) { if(state.activePinIdx !== null) handleMove(e.clientX, e.clientY); }
        function onTouchMove(e) { if(state.activePinIdx !== null) { e.preventDefault(); handleMove(e.touches[0].clientX, e.touches[0].clientY); } }
        
        function handleMove(clientX, clientY) {
            const rect = dom.imageFrame.getBoundingClientRect();
            let x = (clientX - rect.left) / rect.width;
            let y = (clientY - rect.top) / rect.height;
            x = Math.max(0, Math.min(1, x));
            y = Math.max(0, Math.min(1, y));
            state.points[state.activePinIdx].x = x;
            state.points[state.activePinIdx].y = y;
            const pin = dom.pinLayer.children[state.activePinIdx];
            pin.style.left = `${x * 100}%`;
            pin.style.top = `${y * 100}%`;
            updatePalette();
        }

        function onEndMove() { state.activePinIdx = null; }

        function updatePalette() {
            if(!state.image) return;
            const ctx = dom.bufferCanvas.getContext('2d');
            const w = dom.bufferCanvas.width;
            const h = dom.bufferCanvas.height;

            state.points.forEach(p => {
                const pix = ctx.getImageData(p.x * w, p.y * h, 1, 1).data;
                p.r = pix[0]; p.g = pix[1]; p.b = pix[2];
                p.hex = rgbToHex(pix[0], pix[1], pix[2]);
                // Perceived luminance formula
                p.lum = 0.299 * pix[0] + 0.587 * pix[1] + 0.114 * pix[2];
            });

            // CREATE SORTED CLONE for Display and Export
            const sortedPoints = [...state.points].sort((a, b) => b.lum - a.lum); // Dark to Light or vice versa

            // Update UI Sidebar
            dom.stripList.innerHTML = '';
            sortedPoints.forEach((p, i) => {
                const strip = document.createElement('div');
                strip.className = 'strip';
                strip.style.backgroundColor = p.hex;
                strip.innerHTML = `<span class="strip-hex font-num">${p.hex}</span><span class="strip-idx font-num">0${i+1}</span>`;
                dom.stripList.appendChild(strip);
            });

            // Update Live Preview Canvas
            renderPalette(dom.previewCanvas, sortedPoints, 400); // Small preview
        }

        function renderPalette(canvas, points, size) {
            canvas.width = size;
            canvas.height = size;
            const ctx = canvas.getContext('2d');
            const scale = size / 1200;

            // 1. Background
            ctx.fillStyle = "#FFFFFF";
            ctx.fillRect(0, 0, size, size);

            // 2. Barcode Layout
            const padding = 180 * scale;
            const cSize = size - (padding * 2);
            const barW = cSize / 5;
            const barH = cSize * 0.82;

            points.forEach((p, i) => {
                ctx.fillStyle = p.hex;
                ctx.fillRect(padding + (i * barW), padding, barW, barH);
                
                // Labels (Only for high res or clear enough)
                ctx.fillStyle = '#050505';
                ctx.font = `${32 * scale}px "Jost"`;
                ctx.textAlign = 'center';
                ctx.fillText(p.hex, padding + (i * barW) + (barW/2), padding + barH + (50 * scale));
            });

            // 3. Signature
            ctx.textAlign = 'right';
            ctx.fillStyle = '#DDD';
            ctx.font = `${22 * scale}px "Tenor Sans"`;
            ctx.fillText("IRO // CHROMATIC HARMONY", size - padding, size - (40 * scale));
        }

        function downloadPalette() {
            const size = 1200;
            const canvas = dom.exportCanvas;
            const sortedPoints = [...state.points].sort((a, b) => b.lum - a.lum);
            renderPalette(canvas, sortedPoints, size);

            const link = document.createElement('a');
            link.download = `${state.filename}_IRO_HARMONY.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }

        function rgbToHex(r, g, b) {
            return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
        }
    </script>
</body>
</html>